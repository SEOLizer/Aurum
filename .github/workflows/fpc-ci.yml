name: FPC CI

on:
  push:
    branches: [ main, feat/tests/if-parser, feat/syntax/aurum-grammar ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install FreePascal
        run: |
          sudo apt-get update
          sudo apt-get install -y fpc

      - name: Show FPC version
        run: fpc -v

      - name: Build and run tests
        run: |
          set -e
          make test
          make syntax-test

      - name: Build aurumc compiler
        run: |
          set -e
          fpc -O2 -Mobjfpc -Sh aurumc.lpr -oaurumc

      - name: Run example integration tests
        run: |
          set -e
          ./aurumc examples/use_env.au -o /tmp/use_env || true
          /tmp/use_env arg1 arg2 || true
          ./aurumc examples/use_math.au -o /tmp/use_math || true
          /tmp/use_math || true
